name: Android Kernel Driver Builder (module-only)

on:
  workflow_dispatch:
    inputs:
      android_version:
        description: 'Android Version (Kernel) (e.g., 14)'
        required: true
      kernel_version:
        description: 'Kernel Version (e.g., 6.1)'
        required: true
      driver_name:
        description: 'Driver Module Name (unused for upload; e.g., mydriver.ko)'
        required: true
      target_arch:
        description: 'Target Architecture (aarch64, x86_64)'
        required: true
        default: 'aarch64'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.2.2

      - name: Prepare kerneldriver directory
        run: |
          mkdir -p kerneldriver
          mv ./code/*.h ./code/*.c ./code/Makefile kerneldriver/ 2>/dev/null || true

      - name: Install repo tool
        run: |
          sudo curl -L https://storage.googleapis.com/git-repo-downloads/repo -o /usr/local/bin/repo
          sudo chmod a+x /usr/local/bin/repo

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential flex bison libssl-dev libelf-dev bc python3 python-is-python3 gawk rsync ccache \
            clang lld llvm binutils-aarch64-linux-gnu \
            dwarves unifdef libncurses-dev pkg-config \
            zstd lz4 xz-utils cpio tar unzip file git
          sudo apt-get clean

      - name: Set up Android Kernel source
        run: |
          mkdir -p android-kernel && cd android-kernel
          repo init -u https://android.googlesource.com/kernel/manifest -b common-android${{ github.event.inputs.android_version }}-${{ github.event.inputs.kernel_version }}
          repo sync -j"$(nproc)" -c --no-tags --optimized-fetch --force-sync

      - name: Copy kerneldriver into tree
        run: |
          cd android-kernel
          mkdir -p common/drivers/kerneldriver
          cp -r ../kerneldriver/* common/drivers/kerneldriver/ 2>/dev/null || true

      - name: Setup build env
        env:
          INPUT_ARCH: ${{ github.event.inputs.target_arch }}
        run: |
          set -e
          cd android-kernel
          KROOT="$PWD"
          KERNEL_DIR="$KROOT/common"

          case "${INPUT_ARCH}" in
            aarch64) ARCH=arm64;   TRIPLE=aarch64-linux-gnu- ;;
            x86_64)  ARCH=x86_64;  TRIPLE=x86_64-linux-gnu-  ;;
            *) echo "Unsupported target_arch: ${INPUT_ARCH}"; exit 1 ;;
          esac

          if [ -f "$KERNEL_DIR/arch/${ARCH}/configs/gki_defconfig" ]; then
            DEFCONFIG=gki_defconfig
          elif [ -f "$KERNEL_DIR/arch/${ARCH}/configs/defconfig" ]; then
            DEFCONFIG=defconfig
          else
            echo "No defconfig found for ARCH=${ARCH}"
            exit 1
          fi

          if compgen -G "$KROOT/prebuilts/clang/host/linux-x86/clang-*/bin/clang" > /dev/null; then
            CLANG_BIN_DIR=$(ls -d "$KROOT"/prebuilts/clang/host/linux-x86/clang-*/bin | sort | tail -n 1)
            echo "PATH=$CLANG_BIN_DIR:$PATH" >> $GITHUB_ENV
          fi

          echo "ARCH=$ARCH" >> $GITHUB_ENV
          echo "TRIPLE=$TRIPLE" >> $GITHUB_ENV
          echo "KROOT=$KROOT" >> $GITHUB_ENV
          echo "KERNEL_DIR=$KERNEL_DIR" >> $GITHUB_ENV
          echo "DEFCONFIG=$DEFCONFIG" >> $GITHUB_ENV
          echo "KOUT=$KROOT/out/${ARCH}" >> $GITHUB_ENV
          echo "KO_DIR=$KROOT/out/${ARCH}/drivers/kerneldriver" >> $GITHUB_ENV
          echo "LLVM=1" >> $GITHUB_ENV
          echo "LLVM_IAS=1" >> $GITHUB_ENV
          echo "CROSS_COMPILE=$TRIPLE" >> $GITHUB_ENV
          echo "LD=ld.lld" >> $GITHUB_ENV
          echo "KBUILD_VERBOSE=1" >> $GITHUB_ENV

      - name: Kernel defconfig
        run: |
          set -xeo pipefail
          mkdir -p "$KOUT"
          make -C "$KERNEL_DIR" -j"$(nproc)" \
            ARCH="${ARCH}" O="${KOUT}" \
            LLVM="${LLVM}" LLVM_IAS="${LLVM_IAS}" \
            CROSS_COMPILE="${CROSS_COMPILE}" LD="${LD}" \
            HOSTCC=clang HOSTCXX=clang++ \
            "${DEFCONFIG}" 2>&1 | tee -a "$KROOT/build.log"

      - name: Modules prepare
        run: |
          set -xeo pipefail
          make -C "$KERNEL_DIR" -j"$(nproc)" \
            ARCH="${ARCH}" O="${KOUT}" \
            LLVM="${LLVM}" LLVM_IAS="${LLVM_IAS}" \
            CROSS_COMPILE="${CROSS_COMPILE}" LD="${LD}" \
            HOSTCC=clang HOSTCXX=clang++ \
            prepare modules_prepare 2>&1 | tee -a "$KROOT/build.log"

      - name: Build module only
        run: |
          set -xeo pipefail
          make -C "$KERNEL_DIR" -j"$(nproc)" \
            ARCH="${ARCH}" O="${KOUT}" \
            LLVM="${LLVM}" LLVM_IAS="${LLVM_IAS}" \
            CROSS_COMPILE="${CROSS_COMPILE}" LD="${LD}" \
            HOSTCC=clang HOSTCXX=clang++ \
            M=drivers/kerneldriver modules 2>&1 | tee -a "$KROOT/build.log"

      - name: Ensure at least one .ko exists
        run: |
          set -e
          echo "Listing KO_DIR: ${KO_DIR}"
          ls -al "${KO_DIR}" || true
          if ! find "${KO_DIR}" -maxdepth 1 -type f -name '*.ko' | grep -q .; then
            echo "::error::No .ko built in ${KO_DIR}. See build.log artifact for details."
            exit 1
          fi

      - name: Upload .ko files only
        uses: actions/upload-artifact@v4.6.2
        with:
          name: kerneldriver-ko-${{ github.event.inputs.target_arch }}
          path: |
            ${{ env.KO_DIR }}/*.ko
          if-no-files-found: error

      - name: Upload build log
        if: always()
        uses: actions/upload-artifact@v4.6.2
        with:
          name: build-log-${{ github.run_id }}
          path: ${{ env.KROOT }}/build.log
          if-no-files-found: warn
