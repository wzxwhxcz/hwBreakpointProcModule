name: Android Kernel Driver Builder

on:
  workflow_dispatch:
    inputs:
      android_version:
        description: 'Android Version (Kernel) (e.g., 14)'
        required: true
      kernel_version:
        description: 'Kernel Version (e.g., 6.1)'
        required: true
      driver_name:
        description: 'Driver Module Name (e.g., mydriver.ko)'
        required: true
      target_arch:
        description: 'Target Architecture (aarch64, x86_64, etc.)'
        required: true
        default: 'aarch64'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.2.2
        
      - name: Prepare kerneldriver directory
        run: |
          mkdir -p kerneldriver
          mv ./code/*.h ./code/*.c ./code/Makefile kerneldriver/ 2>/dev/null || true
          
      - name: Install repo tool
        run: |
          sudo curl -L https://storage.googleapis.com/git-repo-downloads/repo -o /usr/local/bin/repo
          sudo chmod a+x /usr/local/bin/repo

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential flex bison libssl-dev libelf-dev bc python-is-python3 gawk unzip

      - name: Set up Android Kernel source
        run: |
          mkdir -p android-kernel && cd android-kernel
          repo init -u https://android.googlesource.com/kernel/manifest -b common-android${{ github.event.inputs.android_version }}-${{ github.event.inputs.kernel_version }}
          repo sync -j"$(nproc)" -c --no-tags --optimized-fetch --force-sync

      - name: Copy kerneldriver into tree
        run: |
          cd android-kernel
          mkdir -p common/drivers/kerneldriver
          cp -r ../kerneldriver/* common/drivers/kerneldriver/ 2>/dev/null || true

      - name: Modify Makefile to build as module (obj-m)
        run: |
          cd android-kernel
          # 以模块方式构建该子目录，确保会产出 .ko
          grep -q "obj-m \+= kerneldriver/" common/drivers/Makefile || echo "obj-m += kerneldriver/" >> common/drivers/Makefile

      - name: Add module to GKI modules list (Android > 13)
        if: ${{ fromJSON(github.event.inputs.android_version) > 13 }}
        run: |
          cd android-kernel
          MODULE_NAME="drivers/kerneldriver/${{ github.event.inputs.driver_name }}"
          # 将模块加入 GKI 模块打包列表，确保会被打进 modules*.tar.gz
          awk -i inplace -v module="$MODULE_NAME" '
            BEGIN { added=0 }
            /_COMMON_GKI_MODULES_LIST = \[/ { in_list=1 }
            in_list && /\]/ {
              if (!added) {
                print "    \"" module "\","
                added=1
              }
              in_list=0
            }
            in_list && !added {
              if (module < $0) {
                print "    \"" module "\","
                added=1
              }
            }
            { print }
          ' common/modules.bzl
          
      - name: Prepare module list for legacy builds (Android <= 13)
        if: ${{ fromJSON(github.event.inputs.android_version) <= 13 }}
        run: |
          cd android-kernel
          echo "drivers/kerneldriver/${{ github.event.inputs.driver_name }}" >> common/android/gki_${{ github.event.inputs.target_arch }}_modules || \
          echo "drivers/kerneldriver/${{ github.event.inputs.driver_name }}" >> common/android/gki_aarch64_modules

      - name: Increase stack frame size limit
        run: |
          cd android-kernel
          find . -type f -name "Makefile*" -exec sed -i 's/-Wframe-larger-than=[0-9]*/-Wframe-larger-than=4096/g' {} +
          grep -q "FRAME_WARN" common/Makefile || echo 'KBUILD_CFLAGS += -Wframe-larger-than=4096' >> common/Makefile

      - name: Fix missing kprobe symbols for Android 13
        if: ${{ fromJSON(github.event.inputs.android_version) == 13 }}
        run: |
          cd android-kernel
          for symbol in register_kprobe unregister_kprobe; do
            grep -q "$symbol" common/android/abi_gki_${{ github.event.inputs.target_arch }} || \
            echo "$symbol" >> common/android/abi_gki_${{ github.event.inputs.target_arch }}
          done
          sed -i '/EXPORT_SYMBOL(unregister_kprobe);/a EXPORT_SYMBOL(register_kprobe);' common/kernel/kprobes.c
          
      - name: Build kernel/module
        run: |
          set -e
          cd android-kernel
          if [ ${{ github.event.inputs.android_version }} -le 13 ]; then
            BUILD_CONFIG=common/build.config.gki.${{ github.event.inputs.target_arch }} LTO=thin build/build.sh -j"$(nproc)"
            DIST_DIR="out/android${{ github.event.inputs.android_version }}-${{ github.event.inputs.kernel_version }}/dist"
          else
            echo "Using Bazel build system for Android ${{ github.event.inputs.android_version }}"
            tools/bazel run //common:kernel_${{ github.event.inputs.target_arch }}_dist
            DIST_DIR="out/kernel_${{ github.event.inputs.target_arch }}/dist"
          fi
          echo "DIST_DIR=$DIST_DIR" >> $GITHUB_ENV

      - name: Extract built .ko from dist archives
        run: |
          set -e
          cd android-kernel
          echo "Using DIST_DIR=${DIST_DIR}"
          mkdir -p "${DIST_DIR}/modules_extracted"
          shopt -s nullglob
          found_archive=0
          for f in "${DIST_DIR}"/*modules*.tar.gz "${DIST_DIR}"/modules.tar.gz; do
            if [ -f "$f" ]; then
              echo "Extracting $f ..."
              tar -xzf "$f" -C "${DIST_DIR}/modules_extracted"
              found_archive=1
            fi
          done
          # 有些场景 bazel 产出 zip
          for z in "${DIST_DIR}"/*modules*.zip; do
            if [ -f "$z" ]; then
              echo "Unzipping $z ..."
              unzip -o "$z" -d "${DIST_DIR}/modules_extracted" >/dev/null
              found_archive=1
            fi
          done
          if [ "$found_archive" -eq 0 ]; then
            echo "No module archives found in ${DIST_DIR}"
          fi
          echo "List extracted modules (if any):"
          find "${DIST_DIR}/modules_extracted" -type f -name '*.ko' -print || true

      - name: Verify desired .ko exists
        run: |
          set -e
          cd android-kernel
          DRIVER="${{ github.event.inputs.driver_name }}"
          if [ -f "${DIST_DIR}/modules_extracted/${DRIVER}" ]; then
            echo "Found ${DRIVER} at modules_extracted root."
            exit 0
          fi
          # 常见目录：lib/modules/<release>/extra 或 updates
          if find "${DIST_DIR}/modules_extracted" -type f -name "${DRIVER}" | grep -q .; then
            echo "Found ${DRIVER} inside extracted tree."
            exit 0
          fi
          echo "Did not find ${DRIVER}. Listing available .ko for debugging:"
          find "${DIST_DIR}/modules_extracted" -type f -name '*.ko' -print || true
          echo "::error::${DRIVER} not found. Please ensure the subdir Makefile builds a module with the same name (obj-m += ${DRIVER%.ko}.o) and that the module is added to the GKI modules list."
          exit 1

      - name: Upload driver .ko only
        uses: actions/upload-artifact@v4.6.2
        with:
          name: ${{ github.event.inputs.driver_name }}-${{ github.event.inputs.target_arch }}
          path: |
            android-kernel/${{ env.DIST_DIR }}/modules_extracted/**/${{ github.event.inputs.driver_name }}
          if-no-files-found: error
