- name: Build kernel module
  run: |
    cd android-kernel
    if [ ${{ github.event.inputs.android_version }} -le 13 ]; then
      BUILD_CONFIG=common/build.config.gki.${{ github.event.inputs.target_arch }} LTO=thin build/build.sh -j32
      OUTPUT_PATH="out/android${{ github.event.inputs.android_version }}-${{ github.event.inputs.kernel_version }}/dist"
    else
      echo "Using Bazel build system for Android ${{ github.event.inputs.android_version }}"
      tools/bazel run //common:kernel_${{ github.event.inputs.target_arch }}_dist
      OUTPUT_PATH="out/kernel_${{ github.event.inputs.target_arch }}"
    fi
    echo "OUTPUT_PATH=$OUTPUT_PATH" >> $GITHUB_ENV
  continue-on-error: false  # 改为 false，构建失败应该停止

# 新增：验证构建成功
- name: Verify build output
  run: |
    cd android-kernel
    if [ ! -d "${{ env.OUTPUT_PATH }}" ]; then
      echo "::error::Output directory not found: ${{ env.OUTPUT_PATH }}"
      exit 1
    fi
    
    MODULE_COUNT=$(find ${{ env.OUTPUT_PATH }} -name "*.ko" | wc -l)
    echo "Found $MODULE_COUNT kernel module(s)"
    
    if [ $MODULE_COUNT -eq 0 ]; then
      echo "::error::No kernel modules found!"
      exit 1
    fi

# 新增：提取 .ko 文件
- name: Extract kernel modules
  run: |
    mkdir -p kernel_modules
    cd android-kernel
    
    # 查找并复制所有 .ko 文件
    find ${{ env.OUTPUT_PATH }} -name "*.ko" -type f | while read ko_file; do
      cp "$ko_file" ../kernel_modules/
      echo "Copied: $(basename $ko_file)"
    done
    
    # 显示详细信息
    cd ../kernel_modules
    echo "=== Kernel Modules Summary ==="
    ls -lh
    echo "Total size: $(du -sh . | cut -f1)"

# 修改：仅上传 .ko 文件
- name: Upload kernel modules
  uses: actions/upload-artifact@v4.6.2
  with:
    name: kernel-modules-android${{ github.event.inputs.android_version }}-${{ github.event.inputs.target_arch }}
    path: kernel_modules/*.ko
    retention-days: 30
    if-no-files-found: error  # 没有文件时报错
