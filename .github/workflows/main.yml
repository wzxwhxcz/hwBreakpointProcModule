name: Android Kernel Driver Builder (module-only)

on:
  workflow_dispatch:
    inputs:
      android_version:
        description: 'Android Version (Kernel) (e.g., 14)'
        required: true
      kernel_version:
        description: 'Kernel Version (e.g., 6.1)'
        required: true
      driver_name:
        description: 'Driver Module Name (e.g., mydriver.ko)'
        required: true
      target_arch:
        description: 'Target Architecture (aarch64, x86_64)'
        required: true
        default: 'aarch64'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.2.2

      - name: Prepare kerneldriver directory
        run: |
          mkdir -p kerneldriver
          mv ./code/*.h ./code/*.c ./code/Makefile kerneldriver/ 2>/dev/null || true

      - name: Install repo tool
        run: |
          sudo curl -L https://storage.googleapis.com/git-repo-downloads/repo -o /usr/local/bin/repo
          sudo chmod a+x /usr/local/bin/repo

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential flex bison libssl-dev libelf-dev bc python-is-python3 gawk rsync ccache \
            clang lld llvm binutils-aarch64-linux-gnu
          sudo apt-get clean

      - name: Set up Android Kernel source
        run: |
          mkdir -p android-kernel && cd android-kernel
          repo init -u https://android.googlesource.com/kernel/manifest -b common-android${{ github.event.inputs.android_version }}-${{ github.event.inputs.kernel_version }}
          repo sync -j"$(nproc)" -c --no-tags --optimized-fetch --force-sync

      - name: Copy kerneldriver into tree
        run: |
          cd android-kernel
          mkdir -p common/drivers/kerneldriver
          cp -r ../kerneldriver/* common/drivers/kerneldriver/ 2>/dev/null || true

      - name: Build module only with Kbuild (no Bazel)
        env:
          INPUT_ARCH: ${{ github.event.inputs.target_arch }}
        run: |
          set -e
          cd android-kernel
          KROOT="$PWD"
          KERNEL_DIR="$KROOT/common"

          # 目标架构映射
          case "${INPUT_ARCH}" in
            aarch64) ARCH=arm64;   TRIPLE=aarch64-linux-gnu- ;;
            x86_64)  ARCH=x86_64;  TRIPLE=x86_64-linux-gnu-  ;;
            *) echo "Unsupported target_arch: ${INPUT_ARCH}"; exit 1 ;;
          esac
          echo "Using ARCH=${ARCH}, TRIPLE=${TRIPLE}"

          # 查找 kernel 预编译的 clang（在 repo 根目录下的 prebuilts/）
          if compgen -G "$KROOT/prebuilts/clang/host/linux-x86/clang-*/bin/clang" > /dev/null; then
            CLANG_BIN_DIR=$(ls -d "$KROOT"/prebuilts/clang/host/linux-x86/clang-*/bin | sort | tail -n 1)
            echo "Using prebuilt clang: $CLANG_BIN_DIR"
            export PATH="$CLANG_BIN_DIR:$PATH"
            export LLVM=1
            export LLVM_IAS=1
            export CLANG_TRIPLE="${TRIPLE}"
          else
            echo "Prebuilt clang not found, falling back to system clang"
            export LLVM=1
            export LLVM_IAS=1
          fi

          # 选择 defconfig（优先 gki_defconfig，不存在则回退到 defconfig）
          if [ -f "$KERNEL_DIR/arch/${ARCH}/configs/gki_defconfig" ]; then
            DEFCONFIG=gki_defconfig
          elif [ -f "$KERNEL_DIR/arch/${ARCH}/configs/defconfig" ]; then
            DEFCONFIG=defconfig
          else
            echo "No defconfig found for ARCH=${ARCH}"
            exit 1
          fi
          echo "Using DEFCONFIG=${DEFCONFIG}"

          # 输出目录
          KOUT="$KROOT/out/${ARCH}"
          mkdir -p "$KOUT"

          # 生成配置并准备内核头
          make -C "$KERNEL_DIR" -j"$(nproc)" ARCH="${ARCH}" O="${KOUT}" LLVM="${LLVM}" LLVM_IAS="${LLVM_IAS}" "${DEFCONFIG}"
          make -C "$KERNEL_DIR" -j"$(nproc)" ARCH="${ARCH}" O="${KOUT}" LLVM="${LLVM}" LLVM_IAS="${LLVM_IAS}" prepare modules_prepare

          # 只编译你的模块
          make -C "$KERNEL_DIR" -j"$(nproc)" ARCH="${ARCH}" O="${KOUT}" LLVM="${LLVM}" LLVM_IAS="${LLVM_IAS}" M=drivers/kerneldriver modules

          # 保存结果路径
          echo "KO_DIR=$KOUT/drivers/kerneldriver" >> $GITHUB_ENV

      - name: Verify and list built .ko
        run: |
          set -e
          DRIVER="${{ github.event.inputs.driver_name }}"
          BASE="${DRIVER%.ko}"
          echo "Listing KO_DIR: ${KO_DIR}"
          ls -al "${KO_DIR}" || true
          if ! find "${KO_DIR}" -maxdepth 1 -type f -name "${DRIVER}" | grep -q .; then
            echo "::error::${DRIVER} not found in ${KO_DIR}. Ensure kerneldriver/Makefile contains: 'obj-m += ${BASE}.o' and the source file(s) compile."
            echo "Available .ko:"
            find "${KO_DIR}" -type f -name '*.ko' -print || true
            exit 1
          fi

      - name: Upload driver .ko only
        uses: actions/upload-artifact@v4.6.2
        with:
          name: ${{ github.event.inputs.driver_name }}-${{ github.event.inputs.target_arch }}
          path: |
            ${{ env.KO_DIR }}/${{ github.event.inputs.driver_name }}
          if-no-files-found: error
