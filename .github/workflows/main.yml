name: Android Kernel Driver Builder (module-only)

on:
  workflow_dispatch:
    inputs:
      android_version:
        description: 'Android Version (Kernel) (e.g., 14)'
        required: true
      kernel_version:
        description: 'Kernel Version (e.g., 6.1)'
        required: true
      driver_name:
        description: 'Driver Module Name (e.g., mydriver.ko)'
        required: true
      target_arch:
        description: 'Target Architecture (aarch64, x86_64)'
        required: true
        default: 'aarch64'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.2.2

      - name: Prepare kerneldriver directory
        run: |
          mkdir -p kerneldriver
          # 允许空 code 目录，不报错
          mv ./code/*.h ./code/*.c ./code/Makefile kerneldriver/ 2>/dev/null || true

      - name: Install repo tool
        run: |
          sudo curl -L https://storage.googleapis.com/git-repo-downloads/repo -o /usr/local/bin/repo
          sudo chmod a+x /usr/local/bin/repo

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential flex bison libssl-dev libelf-dev bc python-is-python3 gawk rsync ccache

      - name: Set up Android Kernel source
        run: |
          mkdir -p android-kernel && cd android-kernel
          repo init -u https://android.googlesource.com/kernel/manifest -b common-android${{ github.event.inputs.android_version }}-${{ github.event.inputs.kernel_version }}
          repo sync -j"$(nproc)" -c --no-tags --optimized-fetch --force-sync

      - name: Copy kerneldriver into tree
        run: |
          cd android-kernel
          mkdir -p common/drivers/kerneldriver
          cp -r ../kerneldriver/* common/drivers/kerneldriver/ 2>/dev/null || true

      - name: Build module only with Kbuild (no Bazel)
        env:
          INPUT_ARCH: ${{ github.event.inputs.target_arch }}
          DRIVER_NAME: ${{ github.event.inputs.driver_name }}
        run: |
          set -e
          cd android-kernel/common

          # 目标架构映射
          case "${INPUT_ARCH}" in
            aarch64) ARCH=arm64;   TRIPLE=aarch64-linux-gnu- ;;
            x86_64)  ARCH=x86_64;  TRIPLE=x86_64-linux-gnu-  ;;
            *) echo "Unsupported target_arch: ${INPUT_ARCH}"; exit 1 ;;
          esac
          echo "Using ARCH=${ARCH}, TRIPLE=${TRIPLE}"

          # 选择最新的 clang 预编译工具链
          CLANG_BIN_DIR=$(ls -d prebuilts/clang/host/linux-x86/clang-*/bin | sort | tail -n 1)
          if [ -z "$CLANG_BIN_DIR" ] || [ ! -d "$CLANG_BIN_DIR" ]; then
            echo "Clang prebuilts not found"; exit 1
          fi
          export PATH="$PWD/$CLANG_BIN_DIR:$PATH"

          # 输出目录
          KOUT="$PWD/../out/${ARCH}"
          mkdir -p "$KOUT"

          # 生成最小构建所需的头文件和配置
          make -j"$(nproc)" ARCH="${ARCH}" O="${KOUT}" LLVM=1 LLVM_IAS=1 gki_defconfig
          make -j"$(nproc)" ARCH="${ARCH}" O="${KOUT}" LLVM=1 LLVM_IAS=1 prepare modules_prepare

          # 只编译你的模块
          make -j"$(nproc)" ARCH="${ARCH}" O="${KOUT}" LLVM=1 LLVM_IAS=1 M=drivers/kerneldriver modules

          # 保存结果路径
          echo "KO_DIR=$KOUT/drivers/kerneldriver" >> $GITHUB_ENV

      - name: Verify and list built .ko
        run: |
          set -e
          echo "Listing KO_DIR: ${KO_DIR}"
          ls -al "${KO_DIR}" || true
          if ! find "${KO_DIR}" -maxdepth 1 -type f -name "${{ github.event.inputs.driver_name }}" | grep -q .; then
            echo "::error::${{ github.event.inputs.driver_name }} not found in ${KO_DIR}. Ensure kerneldriver/Makefile has 'obj-m += ${${{ github.event.inputs.driver_name }}%.ko}.o' and file names match."
            echo "Available .ko:"
            find "${KO_DIR}" -type f -name '*.ko' -print || true
            exit 1
          fi

      - name: Upload driver .ko only
        uses: actions/upload-artifact@v4.6.2
        with:
          name: ${{ github.event.inputs.driver_name }}-${{ github.event.inputs.target_arch }}
          path: |
            ${{ env.KO_DIR }}/${{ github.event.inputs.driver_name }}
          if-no-files-found: error
